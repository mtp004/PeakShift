<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React + TS</title>
    <script>
      (() => {
        const CALLBACK = "callback";

        // Ensure google + google.maps exist
        const googleNS = (window.google ||= {});
        const mapsNS = (googleNS.maps ||= {});

        // Track all libraries requested before script loads
        const requestedLibs = new Set();

        let loadPromise = null;

        function loadScript() {
          if (loadPromise) return loadPromise;

          loadPromise = new Promise((resolve, reject) => {
            const script = document.createElement("script");

            const libs = Array.from(requestedLibs).join(",");

            script.src =
              "https://maps.googleapis.com/maps/api/js" +
              "?key=%VITE_GOOGLE_MAPS_API_KEY%" +
              "&v=quarterly" +
              "&libraries=" + libs +
              "&callback=google.maps." + CALLBACK;

            mapsNS[CALLBACK] = resolve;
            script.onerror = () => reject(new Error("Maps API failed to load"));

            const nonceEl = document.querySelector("script[nonce]");
            if (nonceEl) script.nonce = nonceEl.nonce;

            document.head.append(script);
          });

          return loadPromise;
        }

        // Only define wrapper if real importLibrary not present yet
        if (!mapsNS.importLibrary) {
          mapsNS.importLibrary = (lib, ...args) => {
            requestedLibs.add(lib);

            return loadScript().then(() =>
              mapsNS.importLibrary(lib, ...args)
            );
          };
        }
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
